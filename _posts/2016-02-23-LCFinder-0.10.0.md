---
title: LCFinder 0.10.0 开发日志
ds_thread_key: devlog-lcfinder-0.10.0
---
## 2016-04-02
Windows 的照片应用中，每行图片的宽度和数量不是固定的，它会根据图片的具体尺寸来调整，这个特性可以不用急着加到LCFinder里面，先暂时按固定尺寸排列图片，毕竟需要纠结一段时间才能想出合适的实现方案。
[![](/static/images/devlog/photos-screenshot-001.png "Windows 的照片应用")](/static/images/devlog/photos-screenshot-001.png)

## 2016-03-31
现在可以浏览本地文件夹列表了，整个界面就这么点颜色，gif 图居然没有索引到纯白色。
[![](/static/images/devlog/lcfinder-004.gif "文件夹浏览")](/static/images/devlog/lcfinder-004.gif)

## 2016-03-20
现在需要让图片在部件滚动到可见区域内时加载，首先得让滚动条部件能在滚动时触发 scroll 事件，这样就能在滚动时判断有哪些部件在容器的可见区域内。

想为滚动条加上 scroll 事件有些麻烦，触发事件时要准备事件ID和名称，而各个类型的事件ID不是统一管理的，要是被作为滚动层的部件本身也有自己的事件，那么事件ID有可能产生冲突。事件名称与ID的映射关系是保存在每个部件中的，看来需要调整，把它们统一存在一个地方。

## 2016-03-18
文件夹列表可以直接从文件系统里读取，而文件列表则从数据库中读取，这样实现起来就轻松多了。

## 2016-03-17
在“文件夹”视图浏览文件列表时，文件列表该从哪里读取？目前有两种来源：

1. 文件系统，能区分出文件和文件夹，单纯查看文件是没问题，但如果要为文件添加标签、修改其他信息的话就不好处理，因为数据库没文件记录，缓存中也没文件记录，直接往数据库添加文件记录的话，还得往缓存添加文件记录，不然下次同步文件列表时会重复添加文件。目前的文件列表缓存是直接写在一个文件里的，不好操作，要么改用 unqlite 数据库来存储。
2. 数据库，目前数据库只记录文件，视图中无法显示文件夹，如果把文件目录结构也保存到数据库里，看上去有些麻烦。

## 2016-03-15
使用 SQLite 插入数据时可以使用事务、预处理来提升效率，参考文章：http://blog.csdn.net/chenguanzhou123/article/details/9376537

## 2016-03-13
文件被删除/转移位置后需要保留标签和评分数据，有两种做法：

1. 在不破坏文件原有数据的情况下把数据保存在文件中，这个看上去难度有点大。
2. 将文件的sha1值和标签列表分别作为 key 和 value 保存到KV数据库中，这样即使文件改变了位置，只要把它的新位置导入进来再重新同步数据，就能恢复标签和评分信息。

SQLite 数据库插入数据有些慢，才添加200多条记录就要等好几秒，删除也是如此。

## 2016-03-12
测试 LCFinder 的文件列表缓存功能时发现每次都有检测到新增文件，按理来说新文件早就缓存了才对，后来打印 fread() 的返回值，返回值居然与实际记录的文件名长度不一致，奇怪了，数据明显没读完，feof() 也返回非0值。搜索了相关资料，有提到 fopen() 的参数，看了下 LCFinder 的文件读写代码，给两个 fopen() 的参数分别是 "r" 和 "w"，试着改成了 "rb" 和 "wb"，重新测试一遍，OK，问题解决。

## 2016-03-01
之前看过 Google Photos 网页上的功能介绍，据说可以自动识别照片内容，例如：狗，搜索“狗”就能搜索到相关图片，要是 LCFinder 能有这个功能的话，就不用靠用户自己根据图像内容特征来添加标签了，OpenCV有相关特征匹配算法，这样只需要保存各种对象的特征数据，然后程序在导入图片时自动匹配特征并添加标签。看上去特征匹配算法会很耗时，假设进行一次特征匹配需要耗时10ms，有32组特征，每组特征里有10种相关特征的数据，需处理5000张图片，那么耗时大约为：`0.01s*32*10*5000 = 16000s ≈ 4.44小时 `，卧槽，这种功能需要单独开来，弄个界面，告诉用户这个功能大约耗时多长，需要用的话就一直开着程序。图像特征库可以导入/导出，这样可以分享给其它用户，省得每个用户都自己积累特征数据。

## 2016-02-28
为文件夹视图添加了文件同步功能，点击同步按钮后，会显示一个提示框，能看到文件扫描数量的变化。
[![](/static/images/devlog/lcfinder-003.png "文件同步提示框")](/static/images/devlog/lcfinder-003.png)

## 2016-02-25
纯文字看的很枯燥，以下是目前的效果图，以后也会陆续贴一些图，可以从这些图中看到LCFinder的各种变化。

[![](/static/images/devlog/lcfinder-001.png "LCFinder 效果图")](/static/images/devlog/lcfinder-001.png)

[![](/static/images/devlog/lcfinder-002.png "LCFinder 效果图")](/static/images/devlog/lcfinder-002.png)

## 2016-02-24
缩略图缓存用 unqlite 数据库来保存，毕竟只需要用文件路径（key）来获取缩略图（value）。`unqlite_open()` 函数的文件路径参数是 char *类型，而从 sqlite 数据库中保存/读取的文件路径是 UTF-8 编码的，不知道非宽字符版的文件操作函数是以何种编码方式处理文件路径，感觉很有可能是 ANSI，那么需要转换编码。

## 2016-02-23
考虑到 LCFinder 浏览的图片数量会很大，那么就得尽量减少内存占用，起码要能应付10000张图片。首先，需要在内存中弄一块缓存区来缓存缩略图，限制最大占用空间，当达到上限时可释放较老的缩略图缓存来腾出空间。除了内存中，在硬盘中也需要保存缩略图，方便以后读取。缩略图与原图需要保持同步，那么就得在缩略图数据中保存原图的修改时间，当修改时间不一致时更新缩略图。其次，用于显示图片的 LCUI 部件需要弄成单缓存模式，不缓存部件位图，减少内存占用。图片不用一次性载入完，可以分批载入，例如：每次载入100张图片，当浏览到最后几张图片时自动载入下100张图片。

单独开了个日志来记录 LCFinder 的开发动态，代码库：https://github.com/lc-soft/LC-Finder 。LCFinder 是一个资源检索与管理工具，类似于 windows 10 系统中的“照片”应用，开发它是为了满足自己的需求，顺便测试和完善 LCUI 的各项功能。
