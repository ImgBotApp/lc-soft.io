---
title: LCFinder 0.10.0 开发日志
ds_thread_key: devlog-lcfinder-0.10.0
---
## 2016-06-06
有打算让 LC-Finder 成为通用应用（UWP），上架到 windows 应用商店。但和普通应用不一样，毕竟界面不是原生的。

## 2016-05-28
在 Github 的 Issues 页面里有人建议我完善错误处理，也就是针对 malloc() 和 strdup() 返回值为 NULL 的情况做处理，有些地方我会顺手判断一下 malloc() 的返回值，而有的地方不太重要就懒得加了。说到错误处理，以后可以考虑加入运行日志、错误日志和崩溃日志的记录功能，程序崩溃时可以让用户选择反馈错误信息。要实现这个功能，主要需要解决的问题是：如何在程序崩溃时自动调用其它程序？如何获取当前的调用堆栈信息？

错误反馈功能需要做成单独的程序，这样其它程序也能够用它提供的功能。错误反馈的界面可以参考 Chrome 的，只不过附件上传功能可能不会添加。
[![](/static/images/devlog/2016-05-28-16-44-41.png "LCFinder 效果图")](/static/images/devlog/2016-05-28-16-44-41.png)

## 2016-05-23
当有缩略图很多的时候，如果快速滚动缩略图列表到末尾，会需要很长时间才能呈现出缩略图，因为滚动过的区域内的缩略图都在等待加载。为了解决这个问题，可以加上延迟处理，每次触发滚动加载都会重置延迟时间（定时器），直到停止滚动一段时间后才会开始加载缩略图，这样就能跳过中途滚动过的缩略图，直接加载当前停留区域内的缩略图。

## 2016-04-24
清空缩略图列表时还需要删除缓存中的缩略图，不然等到自动排除老缩略图时会访问已删除的部件。切换文件夹目录时，有时会遇到有几个文件夹紧贴着的情况，明明都有设置了外边距。

## 2016-04-23
缩略图列表视图的排版功能已经完成，排版任务是分多次执行的，本以为这样做就不会影响到其它消息的处理，然而实际上还是把整个界面都卡住了，这个问题需要解决。
[![](/static/images/devlog/2016-04-23-21-43-15.png "LCFinder 效果图")](/static/images/devlog/2016-04-23-21-43-15.png)

## 2016-04-21
已经为主页集锦视图内的图片列表添加了按时间段分割效果，LCUI 的排版还有问题，需要解决。

## 2016-04-20
Widget_Empty() 函数的子部件销毁操作需要修改成阻塞式直接执行，异步销毁子部件会使其它正使用该部件的功能出现数据访问越界问题，当 LCFinder 切换文件夹目录并清空子集部件时如果有触发滚动加载，那么该功能会遍历子部件列表，一旦遍历到已销毁的子部件时会导致整个程序异常崩溃。

windows 的“照片”应用的文件夹宽度也是自适应的，看来 LCFinder 需要单独弄一个排版功能，统一修改文件夹和图片缩略图的宽度，修改方式有两种：

1. 添加样式表，覆盖原有样式，这个对于文件夹的宽度修改比较方便，但目前只提供了添加样式表的功能，不能删除样式表，需要的话可以加上。
2. 手动写代码遍历所有部件，逐个设置宽度。这个方法适用于处理图片缩略图的排版，毕竟宽度不是固定的，而且可控制，例如：只对当前可见区域内和前面的缩略图排版，后面的等浏览到时再继续排版。

已经添加了“集锦”视图，只是单纯的把所有图片列了出来，还没加上日期时间分割块，等后面再花时间弄。

## 2016-04-10
已经能显示缩略图了，PNG 图片的支持还好，而 JPG 图片基本无法载入成功。缩放后的缩略图有锯齿，这个问题不大，以后可以换其它缩放算法来解决。
[![](/static/images/devlog/2016-04-10-17-13-31.png "LCFinder 效果图")](/static/images/devlog/2016-04-10-17-13-31.png)

unqlite_open() 函数是按 UTF-8 编码方式处理文件路径的，怪不得之前写入数据库时报 UNQLITE_IOERR 错误。

## 2016-04-07
准备弄缩略图的显示功能，缩略图的载入操作需要放在单独的线程上跑。

## 2016-04-02
Windows 的照片应用中，每行图片的宽度和数量不是固定的，它会根据图片的具体尺寸来调整，这个特性可以不用急着加到LCFinder里面，先暂时按固定尺寸排列图片，毕竟需要纠结一段时间才能想出合适的实现方案。
[![](/static/images/devlog/photos-screenshot-001.png "Windows 的照片应用")](/static/images/devlog/photos-screenshot-001.png)

## 2016-03-31
现在可以浏览本地文件夹列表了，整个界面就这么点颜色，gif 图居然没有索引到纯白色。
[![](/static/images/devlog/lcfinder-004.gif "文件夹浏览")](/static/images/devlog/lcfinder-004.gif)

## 2016-03-20
现在需要让图片在部件滚动到可见区域内时加载，首先得让滚动条部件能在滚动时触发 scroll 事件，这样就能在滚动时判断有哪些部件在容器的可见区域内。

想为滚动条加上 scroll 事件有些麻烦，触发事件时要准备事件ID和名称，而各个类型的事件ID不是统一管理的，要是被作为滚动层的部件本身也有自己的事件，那么事件ID有可能产生冲突。事件名称与ID的映射关系是保存在每个部件中的，看来需要调整，把它们统一存在一个地方。

## 2016-03-18
文件夹列表可以直接从文件系统里读取，而文件列表则从数据库中读取，这样实现起来就轻松多了。

## 2016-03-17
在“文件夹”视图浏览文件列表时，文件列表该从哪里读取？目前有两种来源：

1. 文件系统，能区分出文件和文件夹，单纯查看文件是没问题，但如果要为文件添加标签、修改其他信息的话就不好处理，因为数据库没文件记录，缓存中也没文件记录，直接往数据库添加文件记录的话，还得往缓存添加文件记录，不然下次同步文件列表时会重复添加文件。目前的文件列表缓存是直接写在一个文件里的，不好操作，要么改用 unqlite 数据库来存储。
2. 数据库，目前数据库只记录文件，视图中无法显示文件夹，如果把文件目录结构也保存到数据库里，看上去有些麻烦。

## 2016-03-15
使用 SQLite 插入数据时可以使用事务、预处理来提升效率，参考文章：http://blog.csdn.net/chenguanzhou123/article/details/9376537

## 2016-03-13
文件被删除/转移位置后需要保留标签和评分数据，有两种做法：

1. 在不破坏文件原有数据的情况下把数据保存在文件中，这个看上去难度有点大。
2. 将文件的sha1值和标签列表分别作为 key 和 value 保存到KV数据库中，这样即使文件改变了位置，只要把它的新位置导入进来再重新同步数据，就能恢复标签和评分信息。

SQLite 数据库插入数据有些慢，才添加200多条记录就要等好几秒，删除也是如此。

## 2016-03-12
测试 LCFinder 的文件列表缓存功能时发现每次都有检测到新增文件，按理来说新文件早就缓存了才对，后来打印 fread() 的返回值，返回值居然与实际记录的文件名长度不一致，奇怪了，数据明显没读完，feof() 也返回非0值。搜索了相关资料，有提到 fopen() 的参数，看了下 LCFinder 的文件读写代码，给两个 fopen() 的参数分别是 "r" 和 "w"，试着改成了 "rb" 和 "wb"，重新测试一遍，OK，问题解决。

## 2016-03-01
之前看过 Google Photos 网页上的功能介绍，据说可以自动识别照片内容，例如：狗，搜索“狗”就能搜索到相关图片，要是 LCFinder 能有这个功能的话，就不用靠用户自己根据图像内容特征来添加标签了，OpenCV有相关特征匹配算法，这样只需要保存各种对象的特征数据，然后程序在导入图片时自动匹配特征并添加标签。看上去特征匹配算法会很耗时，假设进行一次特征匹配需要耗时10ms，有32组特征，每组特征里有10种相关特征的数据，需处理5000张图片，那么耗时大约为：`0.01s*32*10*5000 = 16000s ≈ 4.44小时 `，卧槽，这种功能需要单独开来，弄个界面，告诉用户这个功能大约耗时多长，需要用的话就一直开着程序。图像特征库可以导入/导出，这样可以分享给其它用户，省得每个用户都自己积累特征数据。

## 2016-02-28
为文件夹视图添加了文件同步功能，点击同步按钮后，会显示一个提示框，能看到文件扫描数量的变化。
[![](/static/images/devlog/lcfinder-003.png "文件同步提示框")](/static/images/devlog/lcfinder-003.png)

## 2016-02-25
纯文字看的很枯燥，以下是目前的效果图，以后也会陆续贴一些图，可以从这些图中看到LCFinder的各种变化。

[![](/static/images/devlog/lcfinder-001.png "LCFinder 效果图")](/static/images/devlog/lcfinder-001.png)

[![](/static/images/devlog/lcfinder-002.png "LCFinder 效果图")](/static/images/devlog/lcfinder-002.png)

## 2016-02-24
缩略图缓存用 unqlite 数据库来保存，毕竟只需要用文件路径（key）来获取缩略图（value）。`unqlite_open()` 函数的文件路径参数是 char *类型，而从 sqlite 数据库中保存/读取的文件路径是 UTF-8 编码的，不知道非宽字符版的文件操作函数是以何种编码方式处理文件路径，感觉很有可能是 ANSI，那么需要转换编码。

## 2016-02-23
考虑到 LCFinder 浏览的图片数量会很大，那么就得尽量减少内存占用，起码要能应付10000张图片。首先，需要在内存中弄一块缓存区来缓存缩略图，限制最大占用空间，当达到上限时可释放较老的缩略图缓存来腾出空间。除了内存中，在硬盘中也需要保存缩略图，方便以后读取。缩略图与原图需要保持同步，那么就得在缩略图数据中保存原图的修改时间，当修改时间不一致时更新缩略图。其次，用于显示图片的 LCUI 部件需要弄成单缓存模式，不缓存部件位图，减少内存占用。图片不用一次性载入完，可以分批载入，例如：每次载入100张图片，当浏览到最后几张图片时自动载入下100张图片。

单独开了个日志来记录 LCFinder 的开发动态，代码库：https://github.com/lc-soft/LC-Finder 。LCFinder 是一个资源检索与管理工具，类似于 windows 10 系统中的“照片”应用，开发它是为了满足自己的需求，顺便测试和完善 LCUI 的各项功能。
