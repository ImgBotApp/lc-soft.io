---
title: LCFinder 0.10.0 开发日志
ds_thread_key: devlog-lcfinder-0.10.0
---

## 2016-11-13
文件关联功能已经完成。花了点时间设计了个图标，色调为蓝色，扁平化风格，包含 LC 和标签这两种元素，LC 即 LCFinder 开头两个字母，而标签则是表示 LCFinder 具备标签搜索功能。图标弄出来后又为 LCFinder 加上了启动画面，启动画面是参考网易云音乐的，左边是图标，右边则是应用的名称和网址，画面停留 1.5 秒，在以图片查看器模式启动时不会显示启动画面。
[![](/static/images/devlog/2016-11-13-21-48-45.png "启动画面")](/static/images/devlog/2016-11-13-21-48-45.png)

## 2016-11-12
开始添加文件关联功能。当将图片文件路径作为运行参数来启动程序时，会优先初始化图片查看器视图，其它视图则会等到用户在点击返回按钮时初始化，之前有考虑过拆分 ui.xml 和 ui.css，将主界面和照片查看器的布局及样式数据拆分出来，方便单独加载，后来感觉没多大必要，毕竟界面载入速度本身就很快了。

在图片载入完成后再启动文件扫描线程，缓存当前所在文件夹内的所有图片文件。当扫描过当前文件及上/下几张图片后，生成文件迭代器并启用图片切换功能。

照片查看器可以打开多个，但只能有一个主界面，不然多个主界面同时运行一些操作会有可能产生冲突，尤其是数据库。在切换到主界面前，需要知道哪个窗口已经显示了主界面，如果有则关闭照片查看器窗口，然后前置显示主界面窗口。

## 2016-10-31
为文件夹视图添加了文件排序方式选择功能，点击按钮显示菜单，在菜单中选择排序方式。
[![](/static/images/devlog/2016-10-31-00-43-04.png "排序方式选择功能")](/static/images/devlog/2016-10-31-00-43-04.png)

## 2016-10-24
修改了一下缩略图列表视图的布局处理，之前在开始布局前会锁定布局，不让子部件的位置因列表宽度改变而变乱。现在的做法是直接设置列表视图的宽度，这样子部件即使更新布局也不会乱，但又出现了新问题，子部件数量太多的话，布局耗时会很长，最后由于耗时过多，LCUI 会中断本轮部件任务的处理，导致其他部件的任务被推迟。

## 2016-10-16
有些纠结，用了 textview-i18n 部件后，之前为 textview 设置的 CSS 样式就应用不到了，毕竟 textview-i18n 只是继承 textview 的方法，没有继承 CSS 样式，现在有三种解决方法：

- 将 xml 和 css 文档中所有 textview 替换成 textview-i18n。
- 将 css 文档中的 textview 替换成 .text，然后为 xml 文档中的 textview 和 textview-i18n 加上 text 样式类。
- 在 css 文档中的样式表加上 textview-i18n 选择器。

textview-i18n 目前只适合处理纯静态的文本，例如：“当前共占用 100MB 的空间” 这段文本，替换成其他语种的文本的话，中间的 100MB 该怎么处理？100MB 是会变化的，把这段文本分割成三段来处理是比较蠢的做法。可以添加类似于 printf() 函数的控制符功能，为 textivew-i18n 添加个函数，用于绑定数据，数据可以是字符串、整数等，而文本内容则可以是“当前共占用 %s 的空间”，在更新时会自动将 %s 替换成绑定的数据内容。

## 2016-10-15
语言文件已经决定用 yaml 文档格式，参考官方文档实现了 yaml 文档的解析，只做了字符串和哈希表这两种数据结构的处理，其它的用不到。接下来需要弄一个下拉菜单部件来选择语言，点击按钮后能在按钮下面显示下拉菜单。花了些时间把它做出来了，剩下的就是语言文件和全局文本显示（textview）部件的内容刷新功能了。
[![](/static/images/devlog/2016-10-15-23-14-26.png "图片列表中的标识")](/static/images/devlog/2016-10-15-23-14-26.png)

## 2016-10-02
补充了一些提示，当图片不存在或无法识别的时会显示提示，顺便修改了图片查看器里的操作按钮，在图片无效或放大/缩小到限定比例时会禁用按钮。
[![](/static/images/devlog/2016-10-03-00-21-01.png "照片查看器内的提示")](/static/images/devlog/2016-10-03-00-21-01.png)[![](/static/images/devlog/2016-10-02-23-57-18.png "图片列表中的标识")](/static/images/devlog/2016-10-02-23-57-18.png)

## 2016-09-27
了解到 TensorFlow，据说它可以用来做语音识别和图像识别，以后可以花点时间折腾它，为 LC-Finder 加入图像识别功能，这样就能根据用户的添加标签的习惯，自动识别图片内容并添加合适的标签。

## 2016-09-13
完成了时间范围选择器视图，在“集锦”视图中点击时间标题会显示时间范围列表，从中点击一个时间后图片列表就会跳转到这个时间段上。
[![](/static/images/devlog/lcfinder-time-range-select.gif "时间范围选择器")](/static/images/devlog/lcfinder-time-range-select.gif)

顺便贴张图片批量操作功能的截图：
[![](/static/images/devlog/lcfinder-file-multiselect.gif "图片批量操作")](/static/images/devlog/lcfinder-file-multiselect.gif)

## 2016-09-09
写了个用于删除单个文件记录的函数，后来感觉如果批量删除文件时调用这个函数的话效率会很慢，因为每删除一个文件都要先判断是哪个数据库 =》打开数据库 =》删除记录 =》关闭数据库，所以又改成了针对多文件的版本。

## 2016-09-07
打算改用 unqlite 数据库存储文件列表缓存，看了 unqlite 的文档，遍历数据库中所有的记录的方法是：用 unqlite_kv_cursor_init() 初始化一个游标，再用 unqlite_kv_cursor_first_entry() 将游标定位到第一个记录上，之后就进入循环，调用 unqlite_kv_cursor_next_entry() 逐个遍历记录，官方文档是用 unqlite_kv_cursor_key_callback() 函数来读取 key 的，这种方法要穿函数进去，感觉另外写个函数有些麻烦，于是改用 unqlite_kv_cursor_key() 函数直接读取。然而在测试时发现 unqlite_kv_cursor_key() 一直读不出数据，返回的 key 值的长度一直是非常大的负值。后来插了几段测试代码，调试时发现 unqlite_kv_cursor_key() 函数的第三个参数 pnByte 既是输入参数也是输出参数，作为输入参数时是指定 buf 的空间最大字节数，读取完 key 的内容后，输出的值是实际读取的字节数，之前一直以为第三个参数仅仅是输出参数，由于传递了未初始化的 size 进去，导致 key 的内容未被读取出来。

## 2016-08-25
上 Google 云端硬盘发现图片浏览界面还不错，于是照着它这个效果修改了 LC-Finder 的图片查看器界面，然而目前还没实现圆角边框、背景色渐变，只能达到这个效果了，以后再花时间实现。
[![](/static/images/devlog/2016-08-25-23-09-57.jpg "Google 云盘的图片查看器")](/static/images/devlog/2016-08-25-23-09-57.jpg)
[![](/static/images/devlog/2016-08-25-23-47-23.jpg "LCFinder 图片查看器")](/static/images/devlog/2016-08-25-23-47-23.jpg)

考虑到界面的性能，并没有让图片查看器显示在缩略图列表上面，毕竟绘制底层的部件和透明处理也需要耗费一点时间。

图片的上一张/下一张的切换功能已经实现，但只能通过点击按钮才能切换，切换时没有过渡效果，而且不支持触控拖动切换，以后再改进。

测试时发现部件水平居中还有问题，在父级部件尺寸改变后，坐标有时没有自动更新。

## 2016-07-04
Alpha 3 版本已经完成，新增功能的效果图如下：
[![](/static/images/devlog/2016-07-03-00-34-49.jpg "LCFinder 搜索视图")](/static/images/devlog/2016-07-03-00-34-49.jpg)
[![](/static/images/devlog/2016-07-04-12-02-13.jpg "LCFinder 图片信息面板效果图")](/static/images/devlog/2016-07-04-12-02-13.jpg)

## 2016-07-01
注释掉缩略图的写数据库操作的代码后，呈现在界面上的缩略图内容正常，看上去问题出在数据库写操作上，既然数据库写操作能影响到后续读操作读到的数据内容，则说明 unqlite 数据库存在读写冲突，也就说读写操作是非线程安全的。搜索相关资料后发现可以调用 unqlite_lib_is_threadsafe() 函数检测当前 unqlite 函数库是否线程安全，而检测结果是线程不安全的。问题的解决方法很简单，为每个数据库加上一个互斥锁，每次读/写时锁上互斥锁即可。这个问题和以前遇到的 freetype 多线程读字形数据出现的问题类似。

## 2016-06-28
图片的尺寸读取速度异常的慢，为了不影响图片的呈现速度，需要将每张图片的尺寸记录到数据库中。对于初次载入的图片，默认以固定尺寸呈现，在其缩略图载入完后再将原始尺寸存入数据库，等重新排列缩略图列表时再应用新尺寸进行排列。

总会存在几张内容异常的缩略图，估计是哪里出现了内存访问越界。

搜索视图中，打算像文件夹视图那样，以缩略图+文字的形式呈现前标签列表，顶部加上搜索输入框和搜索按钮，用户可以手动输入标签名称，也可以在下方标签列表中点选。

## 2016-06-10
加了个图片信息面板，可以查看基本信息，标签和评分管理功能有待添加。
[![](/static/images/devlog/2016-06-10-22-37-54.jpg "LCFinder 图片信息面板效果图")](/static/images/devlog/2016-06-10-22-37-54.jpg)

## 2016-06-06
有打算让 LC-Finder 成为通用应用（UWP），上架到 windows 应用商店。但和普通应用不一样，毕竟界面不是原生的。

## 2016-05-28
在 Github 的 Issues 页面里有人建议我完善错误处理，也就是针对 malloc() 和 strdup() 返回值为 NULL 的情况做处理，有些地方我会顺手判断一下 malloc() 的返回值，而有的地方不太重要就懒得加了。说到错误处理，以后可以考虑加入运行日志、错误日志和崩溃日志的记录功能，程序崩溃时可以让用户选择反馈错误信息。要实现这个功能，主要需要解决的问题是：如何在程序崩溃时自动调用其它程序？如何获取当前的调用堆栈信息？

错误反馈功能需要做成单独的程序，这样其它程序也能够用它提供的功能。错误反馈的界面可以参考 Chrome 的，只不过附件上传功能可能不会添加。
[![](/static/images/devlog/2016-05-28-16-44-41.png "LCFinder 效果图")](/static/images/devlog/2016-05-28-16-44-41.png)

## 2016-05-23
当有缩略图很多的时候，如果快速滚动缩略图列表到末尾，会需要很长时间才能呈现出缩略图，因为滚动过的区域内的缩略图都在等待加载。为了解决这个问题，可以加上延迟处理，每次触发滚动加载都会重置延迟时间（定时器），直到停止滚动一段时间后才会开始加载缩略图，这样就能跳过中途滚动过的缩略图，直接加载当前停留区域内的缩略图。

## 2016-04-24
清空缩略图列表时还需要删除缓存中的缩略图，不然等到自动排除老缩略图时会访问已删除的部件。切换文件夹目录时，有时会遇到有几个文件夹紧贴着的情况，明明都有设置了外边距。

## 2016-04-23
缩略图列表视图的排版功能已经完成，排版任务是分多次执行的，本以为这样做就不会影响到其它消息的处理，然而实际上还是把整个界面都卡住了，这个问题需要解决。
[![](/static/images/devlog/2016-04-23-21-43-15.png "LCFinder 效果图")](/static/images/devlog/2016-04-23-21-43-15.png)

## 2016-04-21
已经为主页集锦视图内的图片列表添加了按时间段分割效果，LCUI 的排版还有问题，需要解决。

## 2016-04-20
Widget_Empty() 函数的子部件销毁操作需要修改成阻塞式直接执行，异步销毁子部件会使其它正使用该部件的功能出现数据访问越界问题，当 LCFinder 切换文件夹目录并清空子集部件时如果有触发滚动加载，那么该功能会遍历子部件列表，一旦遍历到已销毁的子部件时会导致整个程序异常崩溃。

windows 的“照片”应用的文件夹宽度也是自适应的，看来 LCFinder 需要单独弄一个排版功能，统一修改文件夹和图片缩略图的宽度，修改方式有两种：

1. 添加样式表，覆盖原有样式，这个对于文件夹的宽度修改比较方便，但目前只提供了添加样式表的功能，不能删除样式表，需要的话可以加上。
2. 手动写代码遍历所有部件，逐个设置宽度。这个方法适用于处理图片缩略图的排版，毕竟宽度不是固定的，而且可控制，例如：只对当前可见区域内和前面的缩略图排版，后面的等浏览到时再继续排版。

已经添加了“集锦”视图，只是单纯的把所有图片列了出来，还没加上日期时间分割块，等后面再花时间弄。

## 2016-04-10
已经能显示缩略图了，PNG 图片的支持还好，而 JPG 图片基本无法载入成功。缩放后的缩略图有锯齿，这个问题不大，以后可以换其它缩放算法来解决。
[![](/static/images/devlog/2016-04-10-17-13-31.png "LCFinder 效果图")](/static/images/devlog/2016-04-10-17-13-31.png)

unqlite_open() 函数是按 UTF-8 编码方式处理文件路径的，怪不得之前写入数据库时报 UNQLITE_IOERR 错误。

## 2016-04-07
准备弄缩略图的显示功能，缩略图的载入操作需要放在单独的线程上跑。

## 2016-04-02
Windows 的照片应用中，每行图片的宽度和数量不是固定的，它会根据图片的具体尺寸来调整，这个特性可以不用急着加到LCFinder里面，先暂时按固定尺寸排列图片，毕竟需要纠结一段时间才能想出合适的实现方案。
[![](/static/images/devlog/photos-screenshot-001.png "Windows 的照片应用")](/static/images/devlog/photos-screenshot-001.png)

## 2016-03-31
现在可以浏览本地文件夹列表了，整个界面就这么点颜色，gif 图居然没有索引到纯白色。
[![](/static/images/devlog/lcfinder-004.gif "文件夹浏览")](/static/images/devlog/lcfinder-004.gif)

## 2016-03-20
现在需要让图片在部件滚动到可见区域内时加载，首先得让滚动条部件能在滚动时触发 scroll 事件，这样就能在滚动时判断有哪些部件在容器的可见区域内。

想为滚动条加上 scroll 事件有些麻烦，触发事件时要准备事件ID和名称，而各个类型的事件ID不是统一管理的，要是被作为滚动层的部件本身也有自己的事件，那么事件ID有可能产生冲突。事件名称与ID的映射关系是保存在每个部件中的，看来需要调整，把它们统一存在一个地方。

## 2016-03-18
文件夹列表可以直接从文件系统里读取，而文件列表则从数据库中读取，这样实现起来就轻松多了。

## 2016-03-17
在“文件夹”视图浏览文件列表时，文件列表该从哪里读取？目前有两种来源：

1. 文件系统，能区分出文件和文件夹，单纯查看文件是没问题，但如果要为文件添加标签、修改其他信息的话就不好处理，因为数据库没文件记录，缓存中也没文件记录，直接往数据库添加文件记录的话，还得往缓存添加文件记录，不然下次同步文件列表时会重复添加文件。目前的文件列表缓存是直接写在一个文件里的，不好操作，要么改用 unqlite 数据库来存储。
2. 数据库，目前数据库只记录文件，视图中无法显示文件夹，如果把文件目录结构也保存到数据库里，看上去有些麻烦。

## 2016-03-15
使用 SQLite 插入数据时可以使用事务、预处理来提升效率，参考文章：http://blog.csdn.net/chenguanzhou123/article/details/9376537

## 2016-03-13
文件被删除/转移位置后需要保留标签和评分数据，有两种做法：

1. 在不破坏文件原有数据的情况下把数据保存在文件中，这个看上去难度有点大。
2. 将文件的sha1值和标签列表分别作为 key 和 value 保存到KV数据库中，这样即使文件改变了位置，只要把它的新位置导入进来再重新同步数据，就能恢复标签和评分信息。

SQLite 数据库插入数据有些慢，才添加200多条记录就要等好几秒，删除也是如此。

## 2016-03-12
测试 LCFinder 的文件列表缓存功能时发现每次都有检测到新增文件，按理来说新文件早就缓存了才对，后来打印 fread() 的返回值，返回值居然与实际记录的文件名长度不一致，奇怪了，数据明显没读完，feof() 也返回非0值。搜索了相关资料，有提到 fopen() 的参数，看了下 LCFinder 的文件读写代码，给两个 fopen() 的参数分别是 "r" 和 "w"，试着改成了 "rb" 和 "wb"，重新测试一遍，OK，问题解决。

## 2016-03-01
之前看过 Google Photos 网页上的功能介绍，据说可以自动识别照片内容，例如：狗，搜索“狗”就能搜索到相关图片，要是 LCFinder 能有这个功能的话，就不用靠用户自己根据图像内容特征来添加标签了，OpenCV有相关特征匹配算法，这样只需要保存各种对象的特征数据，然后程序在导入图片时自动匹配特征并添加标签。看上去特征匹配算法会很耗时，假设进行一次特征匹配需要耗时10ms，有32组特征，每组特征里有10种相关特征的数据，需处理5000张图片，那么耗时大约为：`0.01s*32*10*5000 = 16000s ≈ 4.44小时 `，卧槽，这种功能需要单独开来，弄个界面，告诉用户这个功能大约耗时多长，需要用的话就一直开着程序。图像特征库可以导入/导出，这样可以分享给其它用户，省得每个用户都自己积累特征数据。

## 2016-02-28
为文件夹视图添加了文件同步功能，点击同步按钮后，会显示一个提示框，能看到文件扫描数量的变化。
[![](/static/images/devlog/lcfinder-003.png "文件同步提示框")](/static/images/devlog/lcfinder-003.png)

## 2016-02-25
纯文字看的很枯燥，以下是目前的效果图，以后也会陆续贴一些图，可以从这些图中看到LCFinder的各种变化。

[![](/static/images/devlog/lcfinder-001.png "LCFinder 效果图")](/static/images/devlog/lcfinder-001.png)

[![](/static/images/devlog/lcfinder-002.png "LCFinder 效果图")](/static/images/devlog/lcfinder-002.png)

## 2016-02-24
缩略图缓存用 unqlite 数据库来保存，毕竟只需要用文件路径（key）来获取缩略图（value）。`unqlite_open()` 函数的文件路径参数是 char *类型，而从 sqlite 数据库中保存/读取的文件路径是 UTF-8 编码的，不知道非宽字符版的文件操作函数是以何种编码方式处理文件路径，感觉很有可能是 ANSI，那么需要转换编码。

## 2016-02-23
考虑到 LCFinder 浏览的图片数量会很大，那么就得尽量减少内存占用，起码要能应付10000张图片。首先，需要在内存中弄一块缓存区来缓存缩略图，限制最大占用空间，当达到上限时可释放较老的缩略图缓存来腾出空间。除了内存中，在硬盘中也需要保存缩略图，方便以后读取。缩略图与原图需要保持同步，那么就得在缩略图数据中保存原图的修改时间，当修改时间不一致时更新缩略图。其次，用于显示图片的 LCUI 部件需要弄成单缓存模式，不缓存部件位图，减少内存占用。图片不用一次性载入完，可以分批载入，例如：每次载入100张图片，当浏览到最后几张图片时自动载入下100张图片。

单独开了个日志来记录 LCFinder 的开发动态，代码库：https://github.com/lc-soft/LC-Finder 。LCFinder 是一个资源检索与管理工具，类似于 windows 10 系统中的“照片”应用，开发它是为了满足自己的需求，顺便测试和完善 LCUI 的各项功能。
